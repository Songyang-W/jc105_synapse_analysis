#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Tue Sep 16 20:03:02 2025

@author: songyangwang
"""
from caveclient import CAVEclient
from requests import HTTPError
import time
import numpy as np

client = CAVEclient("jchen_mouse_cortex")
available_version = client.materialize.get_versions()

#root_ids = [720575941034757380, 720575941051511894, 720575941057622500, 720575941059432229, 720575941061126260, 720575941061128820, 720575941061146740, 720575941064570382, 720575941067985577, 720575941070687028, 720575941071245374, 720575941071680793, 720575941073277164, 720575941073777040, 720575941073819897, 720575941074810450, 720575941075022386, 720575941076332278, 720575941076653272, 720575941076758746, 720575941077619944, 720575941077776594, 720575941077787090, 720575941077967095, 720575941077982455, 720575941078093229, 720575941079569046, 720575941080298878, 720575941081168930, 720575941086022449, 720575941086431003, 720575941086890090, 720575941086891882, 720575941086918398, 720575941088008859, 720575941088408585, 720575941089298708, 720575941089521081, 720575941089937542, 720575941090078452, 720575941090093556, 720575941091424604, 720575941091445340, 720575941091459932, 720575941091629489, 720575941092498657, 720575941092554470, 720575941092565911, 720575941092573335, 720575941092598423, 720575941092921542, 720575941093443783, 720575941094478620, 720575941094704098, 720575941095549619, 720575941095921486, 720575941096535230, 720575941096669548, 720575941096896673, 720575941096935073, 720575941097347217, 720575941098226189, 720575941098234637, 720575941098551211, 720575941098673705, 720575941098730638, 720575941099131663, 720575941099212764, 720575941099267859, 720575941099645213, 720575941100429392, 720575941101423751, 720575941101452679, 720575941101509409, 720575941102657600, 720575941102668096, 720575941102712896, 720575941102870780, 720575941103533573, 720575941103924589, 720575941104131039, 720575941104297454, 720575941104309998, 720575941104699619, 720575941104700643, 720575941104705251, 720575941105379336, 720575941106152505, 720575941106477402, 720575941106600928, 720575941106639968, 720575941107285320, 720575941107298120, 720575941107437825, 720575941107829776, 720575941109570314, 720575941109605752, 720575941113287333, 720575941114006852, 720575941114011460, 720575941114493115, 720575941114493371, 720575941114494139, 720575941114687139, 720575941114711203, 720575941114933738, 720575941115332394, 720575941115960573, 720575941116548740, 720575941116572664, 720575941116663435, 720575941116976341, 720575941116997589, 720575941117000149, 720575941118374002, 720575941118374514, 720575941120382861, 720575941120702062, 720575941120904478, 720575941121184239, 720575941123725826, 720575941123736578, 720575941124436677, 720575941125743543, 720575941125953181, 720575941126229860, 720575941127918527, 720575941128195568, 720575941128216130, 720575941128500170, 720575941128608670, 720575941128703583, 720575941131576319, 720575941131588607, 720575941132405960, 720575941134134113, 720575941136000282, 720575941139252669, 720575941139510444, 720575941143312378, 720575941144379311, 720575941145828823, 720575941148267857, 720575941149954781, 720575941149993181, 720575941150910648, 720575941152155190, 720575941152796324, 720575941153471868, 720575941153561801, 720575941153566409, 720575941154431375, 720575941154453647, 720575941156114821, 720575941157944107, 720575941158042818, 720575941162298010, 720575941174542567, 720575941183694464, 720575941190025408, 720575941239851589]
#root_ids = [720575941034757380,720575941061146740,720575941078243464,720575941080862517,720575941091655345,720575941095553939,720575941100446032,720575941105542642,720575941106514522,720575941130485550]
root_ids=[720575941034757380, 720575941051511894, 720575941056439930, 720575941057622500, 720575941059432229, 720575941061126260, 720575941061128820, 720575941061146740, 720575941061678719, 720575941064570382, 720575941067985577, 720575941070687028, 720575941071245374, 720575941071680793, 720575941071916714, 720575941072486769, 720575941073277164, 720575941073777040, 720575941073819897, 720575941074810450, 720575941075022386, 720575941076332278, 720575941076653272, 720575941076758746, 720575941077546069, 720575941077619944, 720575941077673448, 720575941077776594, 720575941077787090, 720575941077967095, 720575941077982455, 720575941078093229, 720575941079569046, 720575941080165231, 720575941080167279, 720575941080298878, 720575941080775000, 720575941080862517, 720575941081168930, 720575941084559824, 720575941086022449, 720575941086431003, 720575941086890090, 720575941086891882, 720575941086905706, 720575941086918398, 720575941088008859, 720575941088408585, 720575941089298708, 720575941089521081, 720575941089937542, 720575941090078452, 720575941090093556, 720575941090114548, 720575941091424604, 720575941091445340, 720575941091459932, 720575941091468380, 720575941091629489, 720575941091655345, 720575941092457589, 720575941092498657, 720575941092554470, 720575941092565911, 720575941092573335, 720575941092598423, 720575941092921542, 720575941092936902, 720575941093443783, 720575941093518744, 720575941094478620, 720575941094704098, 720575941095549619, 720575941095553939, 720575941095573783, 720575941095921486, 720575941096535230, 720575941096555454, 720575941096669548, 720575941096896673, 720575941096935073, 720575941097347217, 720575941098226189, 720575941098234637, 720575941098551211, 720575941098673705, 720575941098730638, 720575941099131663, 720575941099212764, 720575941099267859, 720575941099645213, 720575941099683613, 720575941100429392, 720575941100446032, 720575941101423751, 720575941101452679, 720575941101509409, 720575941102657600, 720575941102668096, 720575941102712896, 720575941102870780, 720575941103533573, 720575941103924589, 720575941104131039, 720575941104297454, 720575941104309998, 720575941104315630, 720575941104699619, 720575941104700643, 720575941104705251, 720575941105379336, 720575941105542642, 720575941106152505, 720575941106477402, 720575941106514522, 720575941106569275, 720575941106600928, 720575941106639968, 720575941106781364, 720575941107285320, 720575941107298120, 720575941107437825, 720575941107829776, 720575941109570314, 720575941109605752, 720575941109631352, 720575941109652438, 720575941111813910, 720575941113287333, 720575941113932013, 720575941114006852, 720575941114011460, 720575941114493115, 720575941114493371, 720575941114494139, 720575941114687139, 720575941114711203, 720575941114722723, 720575941114933738, 720575941115332394, 720575941115960573, 720575941116548740, 720575941116572664, 720575941116663435, 720575941116688523, 720575941116976341, 720575941116997589, 720575941117000149, 720575941118374002, 720575941118374514, 720575941118399858, 720575941120382861, 720575941120661373, 720575941120688238, 720575941120702062, 720575941120718958, 720575941120904478, 720575941120910878, 720575941121184239, 720575941121785027, 720575941123725826, 720575941123736578, 720575941123762434, 720575941124429179, 720575941124436677, 720575941125743543, 720575941125953181, 720575941126229860, 720575941127918527, 720575941128195568, 720575941128211440, 720575941128216130, 720575941128500170, 720575941128608670, 720575941128703583, 720575941130278034, 720575941130484270, 720575941130485550, 720575941130920057, 720575941130940793, 720575941131576319, 720575941131588607, 720575941132405960, 720575941132411592, 720575941134134113, 720575941134482618, 720575941135132003, 720575941136000282, 720575941136015386, 720575941139252669, 720575941139510444, 720575941143312378, 720575941144379311, 720575941145828823, 720575941145857751, 720575941146944394, 720575941148267857, 720575941149954781, 720575941149993181, 720575941150386818, 720575941150910648, 720575941152155190, 720575941152796324, 720575941153471868, 720575941153561801, 720575941153566409, 720575941154431375, 720575941154453647, 720575941156114821, 720575941157944107, 720575941158042818, 720575941158069698, 720575941162298010, 720575941162324634, 720575941162325146, 720575941174542567, 720575941174552295, 720575941183694464, 720575941190025408, 720575941239851589]
root_to_versions = {rid: [] for rid in root_ids}

for v in available_version:
    try:
        # Query either side separately (OR condition via two calls)
        client.materialize.version=v
        syn_pre  = client.materialize.synapse_query(
            pre_ids=root_ids, remove_autapses=True,
            desired_resolution=[7.5, 7.5, 50]
        )
        syn_post = client.materialize.synapse_query(
            post_ids=root_ids, remove_autapses=True,
            desired_resolution=[7.5, 7.5, 50]
        )
    except HTTPError:
        time.sleep(0.1)
        continue
    # Unique IDs observed at this version on either side
    pre_ids_found  = syn_pre['pre_pt_root_id'].unique()  if len(syn_pre)  else np.array([], dtype=np.int64)
    post_ids_found = syn_post['post_pt_root_id'].unique() if len(syn_post) else np.array([], dtype=np.int64)
    exist_ids = np.union1d(pre_ids_found, post_ids_found)
    for rid in exist_ids:
        rid = int(rid)
        if rid in root_to_versions:   # guard if DB returns neighbors not in your list
            root_to_versions[rid].append(v)

print(root_to_versions)